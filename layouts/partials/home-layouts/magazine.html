{{- /*
  Magazine 首页布局

  特点:
  - Hero区域: 1篇大型特色文章 + 2篇小型特色文章
  - 编辑推荐: 4-6篇精选文章(横向卡片)
  - 热门分类: 前3个分类,每个显示4篇文章
  - 杂志风格,强调视觉冲击力

  配置:
    params.homepage.magazine.heroPostsCount (默认: 3)
    params.homepage.magazine.featuredPostsCount (默认: 6)
    params.homepage.magazine.topCategoriesCount (默认: 3)
    params.homepage.magazine.postsPerCategory (默认: 4)
*/ -}}

{{ define "main" }}

{{- /* 获取配置参数 */ -}}
{{- $heroPostsCount := site.Params.homepage.magazine.heroPostsCount | default 3 -}}
{{- $featuredPostsCount := site.Params.homepage.magazine.featuredPostsCount | default 6 -}}
{{- $topCategoriesCount := site.Params.homepage.magazine.topCategoriesCount | default 3 -}}
{{- $postsPerCategory := site.Params.homepage.magazine.postsPerCategory | default 4 -}}

{{- /* 获取所有主要内容 */ -}}
{{- $mainSections := site.Params.mainSections | default (slice "posts") -}}
{{- $allPosts := where site.RegularPages "Type" "in" $mainSections -}}

{{- /* Hero 文章 */ -}}
{{- $heroPosts := $allPosts | first $heroPostsCount -}}
{{- $mainHero := index $heroPosts 0 -}}
{{- $sideHeroes := $heroPosts | after 1 -}}

{{- /* 编辑推荐文章(排除 Hero) */ -}}
{{- $featuredPosts := $allPosts | after $heroPostsCount | first $featuredPostsCount -}}

{{- /* 收集已展示的文章用于排除 */ -}}
{{- $excludedPages := $heroPosts | append $featuredPosts -}}

{{- /* 获取顶级分类 */ -}}
{{- $topCategories := partial "functions/get-top-categories" (dict "context" . "limit" $topCategoriesCount "minPosts" 3) -}}

<!-- Hero 区域 -->
<section class="mb-12 md:mb-16 mt-8 md:mt-12">
  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    {{- /* 主要 Hero 文章 - 占2列 */ -}}
    {{- with $mainHero -}}
    <div class="md:col-span-2 group relative overflow-hidden rounded-xl shadow-xl hover:shadow-2xl transition-all duration-300">
      <a href="{{ .RelPermalink }}" class="block">
        <div class="aspect-video md:aspect-[21/9] relative overflow-hidden">
          {{- $img := .Params.image | default "" -}}
          {{- if $img -}}
          <img
            src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20width=%221%22%20height=%221%22/%3E"
            data-src="{{ $img }}"
            alt="{{ .Title }}"
            class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110 lazyload"
            loading="lazy"
            decoding="async"
          >
          {{- end -}}
          {{- /* 渐变遮罩 */ -}}
          <div class="absolute inset-0 bg-gradient-to-t from-black/80 via-black/40 to-transparent"></div>

          {{- /* 内容 */ -}}
          <div class="absolute bottom-0 left-0 right-0 p-6 md:p-8 text-white">
            {{- with index .Params.categories 0 -}}
            <span class="inline-block px-3 py-1 bg-primary-600 rounded-full text-xs font-semibold uppercase tracking-wider mb-3">{{ . }}</span>
            {{- end -}}
            <h2 class="text-2xl md:text-4xl font-bold mb-3 line-clamp-2 leading-tight">{{ .Title }}</h2>
            {{- with .Description -}}
            <p class="text-base md:text-lg text-gray-200 line-clamp-2 mb-3">{{ . }}</p>
            {{- end -}}
            <time class="text-sm text-gray-300" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
          </div>
        </div>
      </a>
    </div>
    {{- end -}}

    {{- /* 侧边 Hero 文章 - 占1列 */ -}}
    <div class="flex flex-col gap-6">
      {{- range $sideHeroes -}}
      <div class="group relative overflow-hidden rounded-lg shadow-lg hover:shadow-xl transition-all duration-300 flex-1">
        <a href="{{ .RelPermalink }}" class="block h-full">
          <div class="aspect-video relative overflow-hidden">
            {{- $img := .Params.image | default "" -}}
            {{- if $img -}}
            <img
              src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20width=%221%22%20height=%221%22/%3E"
              data-src="{{ $img }}"
              alt="{{ .Title }}"
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 lazyload"
              loading="lazy"
              decoding="async"
            >
            {{- end -}}
            <div class="absolute inset-0 bg-gradient-to-t from-black/70 to-transparent"></div>

            <div class="absolute bottom-0 left-0 right-0 p-4 text-white">
              {{- with index .Params.categories 0 -}}
              <span class="inline-block px-2 py-1 bg-primary-600 rounded text-xs font-semibold uppercase tracking-wider mb-2">{{ . }}</span>
              {{- end -}}
              <h3 class="text-lg md:text-xl font-bold line-clamp-2 leading-snug">{{ .Title }}</h3>
            </div>
          </div>
        </a>
      </div>
      {{- end -}}
    </div>
  </div>
</section>

<!-- 编辑推荐 -->
<section class="mb-12 md:mb-16">
  <div class="flex items-center mb-6 gap-4">
    <h2 class="text-2xl md:text-3xl font-bold">编辑推荐</h2>
    <div class="h-1 flex-grow bg-primary-200 rounded"></div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    {{- range $featuredPosts -}}
    <article class="group bg-white rounded-lg shadow hover:shadow-lg transition-all duration-300 overflow-hidden flex gap-4 p-4">
      {{- $img := .Params.image | default "" -}}
      {{- if $img -}}
      <div class="flex-shrink-0 w-32 md:w-40">
        <a href="{{ .RelPermalink }}">
          <div class="aspect-square overflow-hidden rounded-lg">
            <img
              src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20width=%221%22%20height=%221%22/%3E"
              data-src="{{ $img }}"
              alt="{{ .Title }}"
              class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110 lazyload"
              loading="lazy"
              decoding="async"
            >
          </div>
        </a>
      </div>
      {{- end -}}

      <div class="flex-1 flex flex-col justify-between min-w-0">
        {{- with index .Params.categories 0 -}}
        <p class="text-xs text-primary-600 font-semibold uppercase tracking-wider mb-1">{{ . }}</p>
        {{- end -}}
        <h3 class="text-base md:text-lg font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-primary-600 transition-colors">
          <a href="{{ .RelPermalink }}">{{ .Title }}</a>
        </h3>
        {{- with .Description -}}
        <p class="text-sm text-gray-600 line-clamp-2 mb-2">{{ . }}</p>
        {{- end -}}
        <time class="text-xs text-gray-500" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
      </div>
    </article>
    {{- end -}}
  </div>
</section>

<!-- 热门分类 -->
{{- range $index, $category := $topCategories -}}
<section class="mb-12 md:mb-16">
  <div class="flex items-center mb-6 gap-4">
    <h2 class="text-xl md:text-2xl font-bold">{{ $category.name }}</h2>
    <a class="border rounded-full py-2 px-4 md:px-6 hover:bg-primary-50 hover:border-primary-300 transition-colors font-medium" href="{{ printf "/categories/%s/" ($category.name | urlize) | relURL }}">查看全部</a>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
    {{- range first $postsPerCategory $category.taxonomy.Pages -}}
    <article class="group bg-white rounded-lg shadow-md hover:shadow-xl transition-all duration-300 overflow-hidden">
      <a href="{{ .RelPermalink }}" class="block">
        <div class="aspect-video overflow-hidden">
          {{- $img := .Params.image | default "" -}}
          {{- if $img -}}
          <img
            src="data:image/svg+xml,%3Csvg%20xmlns=%22http://www.w3.org/2000/svg%22%20width=%221%22%20height=%221%22/%3E"
            data-src="{{ $img }}"
            alt="{{ .Title }}"
            class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-105 lazyload"
            loading="lazy"
            decoding="async"
          >
          {{- end -}}
        </div>
        <div class="p-4">
          <h3 class="text-base font-bold text-gray-900 mb-2 line-clamp-2 group-hover:text-primary-600 transition-colors">{{ .Title }}</h3>
          <time class="text-xs text-gray-500" datetime="{{ .Date.Format "2006-01-02" }}">{{ .Date.Format "January 2, 2006" }}</time>
        </div>
      </a>
    </article>
    {{- end -}}
  </div>
</section>

{{- if lt $index (sub (len $topCategories) 1) -}}
<hr class="my-8">
{{- end -}}

{{- end -}}

<!-- 订阅部分 -->
{{- partial "content/newsletter.html" . -}}

{{ end }}
