<!-- Walineè¯„è®ºç³»ç»Ÿ -->
{{- if ne .Params.comments false -}}
<div id="waline-comments" class="my-8">
  <h2 class="text-2xl font-bold mb-6">ğŸ’¬ è¯„è®ºåŒº</h2>
  <div id="waline"></div>
</div>

<!-- Waline CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/@waline/client@v3/dist/waline.css"
/>

<!-- Waline å“ç‰Œä¸»é¢˜æ ·å¼è¦†ç›– - æµ·æ´‹è“é…è‰² -->
<style>
#waline-comments {
  max-width: 100%;
  overflow-x: hidden;
}

#waline {
  max-width: 100%;
  overflow: hidden;

  /* å“ç‰Œä¸»è‰² - æµ·æ´‹è“ */
  --waline-theme-color: #06b6d4;
  --waline-active-color: #0891b2;

  /* èƒŒæ™¯è‰² */
  --waline-bgcolor-light: #f9fafb;

  /* æ–‡å­—é¢œè‰² */
  --waline-color: #374151;
  --waline-color-light: #6b7280;

  /* è¾¹æ¡† */
  --waline-border-color: #e5e7eb;
  --waline-border: 1px solid #e5e7eb;

  /* åœ†è§’ - ä¸å¡ç‰‡ä¸€è‡´ */
  --waline-border-radius: 0.75rem;

  /* é˜´å½± */
  --waline-box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1);

  /* å­—ä½“ */
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "PingFang SC", "Microsoft YaHei", sans-serif;
}

/* ç§»åŠ¨ç«¯ Waline è¯„è®ºåŒºçº¦æŸ */
@media (max-width: 768px) {
  #waline-comments,
  #waline,
  #waline * {
    max-width: 100% !important;
    box-sizing: border-box !important;
  }

  #waline .wl-editor,
  #waline .wl-input,
  #waline .wl-comment,
  #waline .wl-panel,
  #waline img {
    max-width: 100% !important;
  }

  /* é˜²æ­¢è¯„è®ºå†…å®¹æº¢å‡º */
  #waline .wl-content {
    word-wrap: break-word;
    overflow-wrap: break-word;
    word-break: break-word;
  }
}

/* æäº¤æŒ‰é’® - ä½¿ç”¨å“ç‰Œè‰² */
#waline .wl-btn {
  background: #06b6d4 !important;
  color: white !important;
  border-radius: 0.5rem !important;
  font-weight: 500 !important;
  transition: all 0.2s ease !important;
}

#waline .wl-btn:hover {
  background: #0891b2 !important;
  transform: translateY(-1px);
}

/* è¾“å…¥æ¡†èšç„¦ */
#waline .wl-input:focus,
#waline .wl-editor:focus {
  border-color: #06b6d4 !important;
  box-shadow: 0 0 0 3px rgba(6, 182, 212, 0.1) !important;
}

/* é“¾æ¥é¢œè‰² */
#waline a {
  color: #06b6d4 !important;
}

#waline a:hover {
  color: #0891b2 !important;
}
</style>

<!-- Waline JS -->
<script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v3/dist/waline.js';

  init({
    el: '#waline',
    // ä½¿ç”¨è‡ªå®šä¹‰åŸŸå - ç™»å½•é¡µé¢: https://comments.totvan.com/ui/login
    serverURL: 'https://comments.totvan.com',

    path: window.location.pathname,
    lang: 'zh-CN',

    locale: {
      placeholder: 'æ¬¢è¿ç•™è¨€è®¨è®ºï¼Œæ”¯æŒMarkdownè¯­æ³•...',
      sofa: 'å¿«æ¥å‘è¡¨ç¬¬ä¸€æ¡è¯„è®ºå§~',
      submit: 'æäº¤',
      reply: 'å›å¤',
      cancelReply: 'å–æ¶ˆå›å¤',
      comment: 'è¯„è®º',
      refresh: 'åˆ·æ–°',
      more: 'åŠ è½½æ›´å¤š...',
      preview: 'é¢„è§ˆ',
      emoji: 'è¡¨æƒ…',
      uploadImage: 'ä¸Šä¼ å›¾ç‰‡',
      nick: 'æ˜µç§°',
      mail: 'é‚®ç®±',
      link: 'ç½‘å€',
      login: 'ç™»å½•',
      logout: 'é€€å‡º',
      admin: 'ç®¡ç†å‘˜',
      word: 'å­—',
      seconds: 'ç§’å‰',
      minutes: 'åˆ†é’Ÿå‰',
      hours: 'å°æ—¶å‰',
      days: 'å¤©å‰',
      now: 'åˆšåˆš',
    },

    // è¯„è®ºè€…ä¿¡æ¯
    requiredMeta: ['nick'],
    meta: ['nick', 'mail', 'link'],

    // è¡¨æƒ…åŒ…é…ç½®
    emoji: [
      'https://unpkg.com/@waline/emojis@1.2.0/weibo',
      'https://unpkg.com/@waline/emojis@1.2.0/alus',
      'https://unpkg.com/@waline/emojis@1.2.0/bilibili',
    ],

    // å›¾ç‰‡ä¸Šä¼ é…ç½®
    imageUploader: async (file) => {
      const formData = new FormData();
      formData.append('file', file);

      try {
        const response = await fetch('https://totvan-image-upload.shield-densest0p.workers.dev', {
          method: 'POST',
          body: formData,
        });

        if (!response.ok) {
          throw new Error(`Upload failed: ${response.statusText}`);
        }

        const data = await response.json();

        if (data.url) {
          return data.url;
        } else if (data.error) {
          throw new Error(data.error);
        } else {
          throw new Error('Upload failed');
        }
      } catch (error) {
        console.error('å›¾ç‰‡ä¸Šä¼ é”™è¯¯:', error);
        alert('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + error.message);
        throw error;
      }
    },

    // ç™»å½•é…ç½® - æŒ‡å‘è‡ªå®šä¹‰ç™»å½•é¡µé¢
    {{ if .Site.Params.waline.customLogin.enabled }}
    login: '{{ .Site.Params.waline.customLogin.path | default "/login" }}',
    {{ else }}
    login: 'enable',
    {{ end }}

    // å…¶ä»–é…ç½®
    avatar: 'mp',
    avatarCDN: 'https://sdn.geekzu.org/avatar/',
    avatarForce: false,
    copyright: true,
    dark: 'auto',
    highlighter: false,

    // è¯„è®ºç»Ÿè®¡
    pageview: false,
    comment: true,
  });

  {{ if .Site.Params.waline.customLogin.enabled }}
  // æ‹¦æˆª Waline ç™»å½•æŒ‰é’®ç‚¹å‡»,è·³è½¬åˆ°è‡ªå®šä¹‰ç™»å½•é¡µé¢
  setTimeout(() => {
    const attachLoginHandler = () => {
      // æŸ¥æ‰¾ç™»å½•æŒ‰é’® - ä½¿ç”¨æ›´ç²¾ç¡®çš„é€‰æ‹©å™¨
      const loginButtons = document.querySelectorAll('.wl-info .wl-btn:not(.primary)');

      loginButtons.forEach(button => {
        // æ£€æŸ¥æŒ‰é’®æ–‡æœ¬æ˜¯å¦ä¸º"ç™»å½•"
        if (button.textContent.trim() === 'ç™»å½•' && !button.dataset.customLoginBound) {
          button.dataset.customLoginBound = 'true';

          button.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();

            // ä¿å­˜å½“å‰é¡µé¢URLç”¨äºç™»å½•åè·³è½¬
            const currentURL = window.location.pathname;
            sessionStorage.setItem('WALINE_COMMENT_RETURN_URL', currentURL);

            // è·³è½¬åˆ°è‡ªå®šä¹‰ç™»å½•é¡µé¢
            window.location.href = '{{ .Site.Params.waline.customLogin.path | default "/login" }}?redirect=' + encodeURIComponent(currentURL);

            return false;
          }, true);

          console.log('âœ… Custom login handler attached to Waline login button');
        }
      });
    };

    // ä½¿ç”¨ MutationObserver ç›‘å¬ DOM å˜åŒ–
    const observer = new MutationObserver(() => {
      attachLoginHandler();
    });

    // å¼€å§‹è§‚å¯Ÿ Waline å®¹å™¨
    const walineContainer = document.querySelector('#waline');
    if (walineContainer) {
      observer.observe(walineContainer, {
        childList: true,
        subtree: true
      });

      // ç«‹å³å°è¯•æŸ¥æ‰¾ä¸€æ¬¡
      attachLoginHandler();

      // å»¶è¿Ÿå†æ¬¡å°è¯•(ç¡®ä¿ Waline å®Œå…¨æ¸²æŸ“)
      setTimeout(attachLoginHandler, 500);
      setTimeout(attachLoginHandler, 1500);
    }
  }, 500);
  {{ end }}
</script>
{{- end -}}
