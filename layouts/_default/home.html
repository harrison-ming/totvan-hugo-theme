{{ define "main" }}

{{- /* 第一步: 获取所有分类并按文章数量排序 */ -}}
{{- $categories := slice -}}
{{- range $name, $taxonomy := site.Taxonomies.categories -}}
  {{- $count := len $taxonomy -}}
  {{- if ge $count 2 -}}
    {{- $categories = $categories | append (dict "name" $name "count" $count "taxonomy" $taxonomy) -}}
  {{- end -}}
{{- end -}}
{{- $categories = sort $categories "count" "desc" -}}

{{- /* 第二步: 收集将在首页分类中展示的文章,用于排除 */ -}}
{{- $topCategories := $categories | first 7 -}}
{{- $excludedPages := slice -}}
{{- range $topCategories -}}
  {{- range first 3 .taxonomy.Pages -}}
    {{- $excludedPages = $excludedPages | append . -}}
  {{- end -}}
{{- end -}}

{{- /* 第三步: 获取最新文章,排除已在分类中展示的 */ -}}
{{- $latestPosts := slice -}}
{{- $needed := 3 -}}
{{- range where site.RegularPages "Type" "in" site.Params.mainSections -}}
  {{- if lt (len $latestPosts) $needed -}}
    {{- $currentPage := . -}}
    {{- $isExcluded := false -}}
    {{- range $excludedPages -}}
      {{- if eq .File.UniqueID $currentPage.File.UniqueID -}}
        {{- $isExcluded = true -}}
      {{- end -}}
    {{- end -}}
    {{- if not $isExcluded -}}
      {{- $latestPosts = $latestPosts | append $currentPage -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<!-- 最新文章部分 -->
<section class="mb-8 md:mb-12 mt-10 md:mt-14">
  <div class="flex items-center mb-6 gap-4">
    <h2 class="text-xl md:text-2xl font-bold">最新文章</h2>
    <a class="border rounded-full text-sm py-2 px-4 md:px-5 hover:bg-primary-50 hover:border-primary-300 transition-colors font-medium" href="{{ "/posts/" | absURL }}">查看全部</a>
  </div>

  <!-- Web端显示纵向卡片网格 -->
  <div class="hidden md:grid md:grid-cols-3 gap-x-6 gap-y-10">
    {{ range $latestPosts }}
      {{- partial "content/card-vertical" . -}}
    {{ end }}
  </div>

  <!-- 移动端显示横向卡片列表 -->
  <div class="md:hidden space-y-4">
    {{ range $latestPosts }}
      {{- partial "content/card" . -}}
    {{ end }}
  </div>
</section>

<hr class="my-8">

<!-- 分类部分 - 动态读取导航栏分类顺序 -->

{{- /* 只显示导航栏中的前7个分类 (文章最多的) */ -}}
{{- $topCategories := $categories | first 7 -}}
{{- range $topCategories -}}
  <section class="mb-10">
    <div class="flex items-center mb-6 gap-4">
      <h2 class="text-xl font-bold">{{ .name }}</h2>
      <a class="border rounded-full py-2 px-4 md:px-6 hover:bg-primary-50 hover:border-primary-300 transition-colors" href="{{ printf "/categories/%s/" (.name | urlize) | relURL }}">查看全部</a>
    </div>

    <!-- Web端显示纵向卡片网格 -->
    <div class="hidden md:grid md:grid-cols-3 gap-x-6 gap-y-10">
      {{ range first 3 .taxonomy.Pages }}
        {{- partial "content/card-vertical" . -}}
      {{ end }}
    </div>

    <!-- 移动端显示横向卡片列表 -->
    <div class="md:hidden space-y-4">
      {{ range first 3 .taxonomy.Pages }}
        {{- partial "content/card" . -}}
      {{ end }}
    </div>
  </section>

  <hr class="my-8">
{{- end -}}

<!-- 订阅部分 -->
{{- partial "content/newsletter.html" . -}}

{{ end }} 